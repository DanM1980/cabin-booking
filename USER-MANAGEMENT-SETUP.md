# 🔐 הגדרת מערכת ניהול משתמשים

## סקירה כללית

המערכת מזהה משתמשים באמצעות מספר טלפון שנשמר ב-`localStorage`. 
יש **שני סוגי משתמשים**:
1. **משתמשים רגילים** - יכולים לערוך רק הזמנות שביצעו ולמחוק רק הודעות שכתבו
2. **מנהלים (👑)** - יכולים לערוך ולמחוק את הכל

---

## 📋 שלב 1: הרצת SQL להגדרת DB

עליך להריץ את הקוד הבא ב-**Supabase SQL Editor** כדי:
1. להוסיף את עמודת `guest_phone` לטבלת `guestbook`
2. ליצור את טבלת `admins`
3. להוסיף את שני המנהלים

### קוד SQL להרצה:

```sql
-- 1. הוספת עמודת guest_phone לטבלת guestbook
ALTER TABLE guestbook 
ADD COLUMN IF NOT EXISTS guest_phone VARCHAR(20) NOT NULL DEFAULT 'אנונימי';

-- 2. יצירת טבלת admins
CREATE TABLE IF NOT EXISTS admins (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone VARCHAR(20) UNIQUE NOT NULL,
  name VARCHAR(100),
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. הוספת המנהלים
INSERT INTO admins (phone, name) VALUES
  ('052-8891082', 'דן - מנהל ראשי'),
  ('052-5420326', 'סיון עוז - מנהל')
ON CONFLICT (phone) DO NOTHING;

-- 4. הוספת RLS לטבלת admins
ALTER TABLE admins ENABLE ROW LEVEL SECURITY;

-- 5. מדיניות קריאה - כולם יכולים לקרוא (כדי לבדוק מי מנהל)
DROP POLICY IF EXISTS "Allow public read admins" ON admins;
CREATE POLICY "Allow public read admins" ON admins
  FOR SELECT
  USING (true);
```

### 🔧 איך להריץ:

1. היכנס ל-[Supabase Dashboard](https://app.supabase.com)
2. בחר את הפרויקט שלך
3. לך ל-**SQL Editor** (בתפריט צד)
4. הדבק את הקוד למעלה
5. לחץ **Run** (Ctrl+Enter)

---

## 📱 איך זה עובד מבחינת המשתמש?

### משתמש חדש (פעם ראשונה):
```
1. נכנס לאתר
2. בוחר תאריך
3. ממלא פרטים (שם, טלפון, אימייל)
4. לוחץ "הזמן עכשיו"
   → הטלפון נשמר ב-localStorage
   → המערכת בודקת האם הוא מנהל
   → מוצג בכותרת: "👑 052-8891082" או "052-8891082"
```

### משתמש חוזר:
```
1. נכנס לאתר
2. המערכת מזהה אותו אוטומטית (קוראת מ-localStorage)
3. הטלפון מוצג בכותרת
4. אם לוחץ על יום מוזמן:
   ✅ אם זו ההזמנה שלו → יכול לערוך/למחוק
   ❌ אם זו הזמנה של אחר → "היום מוזמן על ידי משתמש אחר"
```

### מנהל (👑):
```
1. נכנס לאתר
2. המערכת מזהה אותו כמנהל (👑 052-8891082)
3. יכול לערוך ולמחוק את כל ההזמנות
4. יכול למחוק את כל ההודעות בספר האורחים
5. כשמערוך הזמנה של אחר, מוצג: "👑 עריכת מנהל"
```

---

## 🔑 ניהול מנהלים

### הוספת מנהל חדש:
```sql
INSERT INTO admins (phone, name) 
VALUES ('050-1234567', 'שם המנהל');
```

### הסרת מנהל:
```sql
DELETE FROM admins 
WHERE phone = '050-1234567';
```

### רשימת כל המנהלים:
```sql
SELECT * FROM admins ORDER BY created_at DESC;
```

---

## 🚪 התנתקות

משתמש יכול להתנתק בכל עת:
1. לוחץ על "התנתק" בכותרת
2. הטלפון נמחק מ-localStorage
3. הדף מתרענן
4. בהזמנה הבאה יצטרך להזין מחדש את הטלפון

---

## 🛡️ אבטחה

### מה מוגן:
✅ רק בעל ההזמנה יכול לערוך/למחוק אותה  
✅ רק כותב ההודעה יכול למחוק אותה  
✅ מנהלים יכולים הכל  

### מה לא מוגן:
⚠️ זוהי מערכת מבוססת-אמון (Trust-based)  
⚠️ אין אימות טלפון אמיתי (SMS/OTP)  
⚠️ מישהו שיודע טלפון של אחר יכול "להתחזות" אליו  

**למה זה בסדר?**
- זה פרויקט קטן ללא עלות
- אין מידע רגיש
- קהל היעד הוא אנשים שמכירים זה את זה
- מערכת פשוטה = פחות דברים שיכולים להישבר

---

## 🎨 UI/UX

### בכותרת:
```
משתמש רגיל:     052-8891082    [התנתק]
מנהל:          👑 052-8891082  [התנתק]
```

### בספר אורחים:
```
┌──────────────────────────────┐
│ 👤 דן • לפני שעה             │
│    "מקום נפלא!"              │
│                    [🗑️ מחק]  │ ← רק אם זה המשתמש הנוכחי או מנהל
└──────────────────────────────┘
```

### בעריכת הזמנה (מנהל):
```
┌──────────────────────────────┐
│ 👑 עריכת מנהל                │
│ הזמנה של משתמש אחר           │
│                              │
│ שם: יוסי כהן                 │
│ טלפון: 053-1111111           │
│                              │
│ [ עדכן הזמנה ]               │
│ [ ביטול הזמנה ]              │
└──────────────────────────────┘
```

---

## 🧪 בדיקות

### לבדוק כמשתמש רגיל:
1. נקה localStorage (F12 → Console → `localStorage.clear()`)
2. רענן את הדף
3. בצע הזמנה עם טלפון: `050-9999999`
4. נסה לערוך הזמנה של מנהל → ❌ חסום

### לבדוק כמנהל:
1. נקה localStorage
2. בצע הזמנה עם: `052-8891082` או `052-5420326`
3. וודא שמופיע 👑 בכותרת
4. נסה לערוך הזמנה של מישהו אחר → ✅ מותר

---

## 📝 הערות טכניות

### localStorage Structure:
```javascript
localStorage.setItem('userPhone', '052-8891082');
```

### בדיקת מנהל:
```javascript
// בכל פעולה רגישה
const userPhone = localStorage.getItem('userPhone');
const isUserAdmin = await isAdmin(userPhone);

if (isUserAdmin || booking.guest_phone === userPhone) {
  // מותר
} else {
  // אסור
}
```

### Query לבדיקת מנהל:
```sql
SELECT id FROM admins WHERE phone = '052-8891082'
```

אם יש תוצאה → מנהל ✅  
אם אין תוצאה → משתמש רגיל

---

## 🚀 מוכן!

אחרי הרצת ה-SQL, המערכת תהיה מוכנה לשימוש:
- ✅ משתמשים יזוהו לפי טלפון
- ✅ מנהלים יקבלו 👑
- ✅ כל אחד יכול לערוך רק את שלו (אלא אם כן הוא מנהל)

